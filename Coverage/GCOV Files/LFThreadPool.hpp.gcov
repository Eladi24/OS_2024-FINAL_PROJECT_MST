        -:    0:Source:LFThreadPool.hpp
        -:    0:Graph:LFServer.gcno
        -:    0:Data:LFServer.gcda
        -:    0:Runs:2
        -:    1:#ifndef _LFTHREADPOOL_HPP
        -:    2:#define _LFTHREADPOOL_HPP
        -:    3:
        -:    4:#include <vector>
        -:    5:#include <string>
        -:    6:#include "Graph.hpp"
        -:    7:#include "Tree.hpp"
        -:    8:#include "MSTStrategy.hpp"
        -:    9:#include "MSTFactory.hpp"
        -:   10:#include "Reactor.hpp"
        -:   11:#include "ThreadContext.hpp"
        -:   12:
        -:   13:using namespace std;
        -:   14:
        -:   15:/**
        -:   16: * @class LFThreadPool
        -:   17: * @brief Implementation of the Leader-Follower Thread Pool Pattern
        -:   18: *
        -:   19: * The Leader-Follower pattern is a concurrency design pattern where multiple worker threads
        -:   20: * take turns being the leader and followers. The leader is responsible for accepting incoming events (e.g., client connections), 
        -:   21: * and when it begins processing an event, it promotes a follower to be the next leader. 
        -:   22: * This design reduces context switching and synchronization overhead, ensuring that only one thread handles events at a time.
        -:   23: * 
        -:   24: * Components of the Pattern:
        -:   25: * - **Leader**: A thread that waits for and handles incoming events.
        -:   26: * - **Follower**: A thread that waits until promoted to be the leader.
        -:   27: * - **Reactor**: A mechanism that listens for events on file descriptors and notifies the leader thread to handle them.
        -:   28: * - **Thread Pool**: A pool of threads that take turns being the leader and followers.
        -:   29: *
        -:   30: * The LFThreadPool class encapsulates these components and manages the lifecycle of the threads.
        -:   31: */
        -:   32:class LFThreadPool
        -:   33:{
        -:   34:private:
        -:   35:    vector<shared_ptr<ThreadContext>> _followers; ///< A list of follower threads (ThreadContext objects)
        -:   36:    mutex _mx; ///< Mutex to synchronize access to shared resources
        -:   37:    static mutex _outputMx; ///< Mutex to protect shared output resources (e.g., logging or console output)
        -:   38:    condition_variable _condition; ///< Condition variable to notify followers to wake up when needed
        -:   39:    atomic<bool> _stop; ///< Atomic flag to signal stopping the thread pool
        -:   40:    atomic<bool> _leaderChanged; ///< Atomic flag to indicate if the leader has changed
        -:   41:    Reactor& _reactor; ///< Reactor object that manages and dispatches events to the leader
        -:   42:    shared_ptr<ThreadContext> _leader; ///< Pointer to the current leader thread context
        -:   43:
        -:   44:    /**
        -:   45:     * @brief Follower loop function
        -:   46:     * 
        -:   47:     * This function represents the main loop for follower threads. Each follower waits until it is promoted
        -:   48:     * to be the leader or until the thread pool is stopped. When a follower is promoted to leader, it handles
        -:   49:     * the incoming event and then promotes a new leader.
        -:   50:     * 
        -:   51:     * @param id The ID of the thread running this loop.
        -:   52:     */
        -:   53:    void followerLoop(int id);
        -:   54:    
        -:   55:public:
        -:   56:    /**
        -:   57:     * @brief Constructor
        -:   58:     * 
        -:   59:     * Initializes the LFThreadPool with the specified number of threads and a reference to the Reactor.
        -:   60:     * 
        -:   61:     * @param numThreads The number of threads to create in the thread pool.
        -:   62:     * @param reactor The Reactor that manages events (e.g., incoming client connections).
        -:   63:     */
        -:   64:    LFThreadPool(size_t numThreads, Reactor& reactor);
        -:   65:
        -:   66:    /**
        -:   67:     * @brief Destructor
        -:   68:     * 
        -:   69:     * Cleans up the thread pool by stopping all threads and joining them.
        -:   70:     */
        -:   71:    ~LFThreadPool();
        -:   72:
        -:   73:    /**
        -:   74:     * @brief Promote a new leader thread
        -:   75:     * 
        -:   76:     * This method is called by the current leader to promote one of the follower threads to become the next leader.
        -:   77:     * It ensures that there is always a leader available to handle events.
        -:   78:     */
        -:   79:    void promoteNewLeader();
        -:   80:
        -:   81:    /**
        -:   82:     * @brief Join all threads
        -:   83:     * 
        -:   84:     * Waits for all threads in the thread pool to complete their work. This is typically called during shutdown to
        -:   85:     * ensure a clean exit.
        -:   86:     */
        -:   87:    void join();
        -:   88:
        -:   89:    /**
        -:   90:     * @brief Stop the thread pool
        -:   91:     * 
        -:   92:     * Signals all threads in the pool to stop by setting the `_stop` flag. This causes all follower threads to exit
        -:   93:     * their loops, and the pool shuts down gracefully.
        -:   94:     */
        -:   95:    void stopPool();
        -:   96:
        -:   97:    /**
        -:   98:     * @brief Add a file descriptor and associated event handler
        -:   99:     * 
        -:  100:     * Registers a file descriptor with the Reactor and associates it with a specific event handler (e.g., a function
        -:  101:     * that handles a client connection or request).
        -:  102:     * 
        -:  103:     * @param fd The file descriptor to monitor (e.g., a socket for a client connection).
        -:  104:     * @param event The function to execute when the event occurs on the file descriptor.
        -:  105:     */
        -:  106:    void addFd(int fd, function<void()> event);
        -:  107:
        -:  108:    /**
        -:  109:     * @brief Get the output mutex
        -:  110:     * 
        -:  111:     * Returns a reference to the static mutex used for protecting output operations (e.g., console or logging).
        -:  112:     * This ensures that multiple threads do not produce mixed or garbled output.
        -:  113:     * 
        -:  114:     * @return Reference to the output mutex.
        -:  115:     */
function _ZN12LFThreadPool11getOutputMxEv called 2 returned 100% blocks executed 100%
        2:  116:    static mutex& getOutputMx() { return _outputMx; }
        -:  117:};
        -:  118:
        -:  119:#endif
